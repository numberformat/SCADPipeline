<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OpenSCAD STL Viewer</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #eeeeee;
    }
    body {
      font-family: "Trebuchet MS", "Segoe UI", sans-serif;
      color: #222;
    }
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 10px 14px;
      background: rgba(238, 238, 238, 0.95);
      border-bottom: 1px solid #d6d6d6;
      z-index: 2;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    header label {
      font-size: 14px;
      letter-spacing: 0.2px;
    }
    select {
      font-size: 14px;
      padding: 6px 8px;
    }
    #downloadLink {
      font-size: 13px;
      padding: 6px 10px;
      border: 1px solid #c9c9c9;
      border-radius: 6px;
      background: #f7f7f7;
      color: #222;
      text-decoration: none;
    }
    #downloadLink:hover {
      background: #ececec;
    }
    canvas {
      display: block;
    }
    #viewport {
      position: fixed;
      inset: 44px 0 0 0;
    }
    #status {
      font-size: 12px;
      opacity: 0.7;
    }
  </style>

  <!-- Import map required for Three.js example modules -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
    }
  }
  </script>
</head>

<body>

<header>
  <label for="modelSelect">Model</label>
  <select id="modelSelect"></select>
  <a id="downloadLink" href="#" download>Download STL</a>
  <span id="status"></span>
</header>

<div id="viewport"></div>

<script type="module">
import * as THREE from "three";
import { STLLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/STLLoader.js";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";

const statusEl = document.getElementById("status");
const modelSelect = document.getElementById("modelSelect");
const downloadLink = document.getElementById("downloadLink");

/* Scene */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xeeeeee);

/* Camera */
const camera = new THREE.PerspectiveCamera(
  60,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
camera.position.set(40, 40, 40);

/* Renderer */
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
document.getElementById("viewport").appendChild(renderer.domElement);

/* Controls */
new OrbitControls(camera, renderer.domElement);

/* Lighting — OpenSCAD-like (flat + readable) */
scene.add(new THREE.AmbientLight(0xffffff, 0.85));

const dirLight = new THREE.DirectionalLight(0xffffff, 0.4);
dirLight.position.set(2, 3, 4);
scene.add(dirLight);

/* Load STL */
const loader = new STLLoader();
let currentMesh = null;
let currentEdges = null;

function setStatus(message) {
  statusEl.textContent = message;
}

function loadModel(stlPath) {
  setStatus("Loading…");
  downloadLink.href = stlPath;
  downloadLink.setAttribute("download", stlPath);
  loader.load(
    stlPath,
    geometry => {
      geometry.center();

      if (currentMesh) scene.remove(currentMesh);
      if (currentEdges) scene.remove(currentEdges);

      const material = new THREE.MeshStandardMaterial({
        color: 0xffff66,   // OpenSCAD warm yellow
        metalness: 0.0,
        roughness: 0.9
      });

      currentMesh = new THREE.Mesh(geometry, material);
      scene.add(currentMesh);

      /* Optional OpenSCAD-style edge outline */
      const edges = new THREE.EdgesGeometry(geometry);
      currentEdges = new THREE.LineSegments(
        edges,
        new THREE.LineBasicMaterial({ color: 0x000000 })
      );
      scene.add(currentEdges);
      setStatus("");
    },
    undefined,
    () => setStatus("Failed to load STL")
  );
}

async function initModels() {
  try {
    const res = await fetch("models.json");
    const models = await res.json();
    if (!Array.isArray(models) || models.length === 0) throw new Error("empty");

    for (const file of models) {
      const label = file.replace(/\.stl$/i, "");
      const option = document.createElement("option");
      option.value = file;
      option.textContent = label;
      modelSelect.appendChild(option);
    }

    loadModel(models[0]);
  } catch {
    modelSelect.innerHTML = '<option value="cube.stl">cube</option>';
    loadModel("cube.stl");
  }
}

modelSelect.addEventListener("change", () => {
  loadModel(modelSelect.value);
});

/* Resize handling */
window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

/* Render loop */
function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
animate();
initModels();
</script>

</body>
</html>
