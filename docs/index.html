<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>3D Model Viewer</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #f0f0f0;
      height: 100%;
    }
    body {
      font-family: "Trebuchet MS", "Segoe UI", sans-serif;
      color: #222;
    }
    :root {
      --viewer-width: min(800px, 100%);
      --viewer-height: min(600px, 60vh);
    }
    .page {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0;
      min-height: 100vh;
      align-content: start;
      padding: 24px;
      padding-right: 24px;
      box-sizing: border-box;
    }
    .viewer {
      display: grid;
      place-items: center;
      position: relative;
      background: #e6e6e6;
      border-radius: 16px;
      border: 1px solid #d2d2d2;
      overflow: hidden;
      height: var(--viewer-height);
      margin: 0 0 18px 0;
    }
    .viewer-media {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      width: var(--viewer-width);
      height: var(--viewer-height);
      margin: auto;
    }
    .viewer img,
    .viewer canvas {
      width: var(--viewer-width);
      height: var(--viewer-height);
      object-fit: contain;
      background: #f7f7f7;
    }
    .viewer canvas {
      display: none;
    }
    .viewer.stl-mode img {
      display: none;
    }
    .viewer.stl-mode canvas {
      display: block;
    }
    .nav-btn {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 44px;
      border: 0;
      background: rgba(0, 0, 0, 0.08);
      color: #111;
      font-size: 28px;
      cursor: pointer;
      transition: background 0.15s ease;
      z-index: 3;
    }
    .nav-btn:hover {
      background: rgba(0, 0, 0, 0.14);
    }
    .nav-left { left: 0; }
    .nav-right { right: 0; }
    .toggle-btn {
      position: absolute;
      right: 18px;
      top: 18px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #c9c9c9;
      background: #f7f7f7;
      cursor: pointer;
      font-size: 13px;
      z-index: 3;
    }
    .toggle-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }
    .download-btn {
      position: absolute;
      right: 86px;
      top: 18px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #c9c9c9;
      background: #f7f7f7;
      color: #111;
      text-decoration: none;
      font-size: 13px;
      z-index: 3;
    }
    .download-btn.disabled {
      opacity: 0.45;
      pointer-events: none;
    }
    .thumbs {
      background: #ffffff;
      border: 1px solid #d2d2d2;
      border-radius: 16px;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      align-items: flex-start;
      gap: 0;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      margin: 0 0 18px 0;
    }
    .thumbs h2 {
      margin: 6px 6px 12px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      opacity: 0.7;
    }
    #thumbList {
      display: flex;
      gap: 0;
    }
    .thumbs button {
      display: block;
      width: 140px;
      flex: 0 0 auto;
      border: 0;
      padding: 6px;
      background: transparent;
      cursor: pointer;
    }
    .thumbs img {
      width: 100%;
      height: 90px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid transparent;
    }
    .thumbs button:hover img {
      border-color: #111;
    }
    .thumbs button.active img {
      border-color: #111;
    }
    .status {
      margin-top: 8px;
      font-size: 12px;
      opacity: 0.6;
      text-align: center;
    }
    @media (max-width: 1100px) {
      .page {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
      }
      :root {
        --viewer-height: min(60vh, 480px);
      }
      .thumbs h2 {
        margin: 0 10px 0 6px;
        white-space: nowrap;
      }
    }
    .readme {
      margin: 0;
      padding: 0;
      background: transparent;
      border: 0;
    }
    .tabs {
      grid-column: 1 / -1;
      display: flex;
      gap: 6px;
      margin-top: 18px;
      border-bottom: 1px solid #d2d2d2;
    }
    .tab-btn {
      border: 1px solid #d2d2d2;
      border-bottom: 0;
      background: #efefef;
      padding: 8px 14px;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      font-size: 13px;
    }
    .tab-btn.active {
      background: #ffffff;
      color: #111;
      border-color: #d2d2d2;
    }
    .tab-panel {
      grid-column: 1 / -1;
      width: 100%;
      margin: 0 0 48px;
      padding: 24px;
      background: #ffffff;
      border: 1px solid #d2d2d2;
      border-radius: 0 16px 16px 16px;
      box-sizing: border-box;
      color: #222;
    }
    .tab-panel.hidden {
      display: none;
    }
    .page-title {
      grid-column: 1 / -1;
      margin: 8px 0 0;
      font-size: 28px;
      letter-spacing: 0.4px;
    }
    .build-date {
      grid-column: 1 / -1;
      margin: 6px 0 12px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1.6px;
      opacity: 0.6;
    }
    .readme h2 {
      margin: 0 0 16px;
      font-size: 18px;
    }
    .readme pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #f7f7f7;
      padding: 12px 14px;
      border-radius: 10px;
      overflow: auto;
    }
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
    }
  }
  </script>
</head>

<body>

<div class="page">
  <!--PAGE_TITLE-->
  <div class="viewer" id="viewer">
    <button class="nav-btn nav-left" id="prevBtn" aria-label="Previous image">◀</button>
    <div class="viewer-media" id="viewerMedia">
      <img id="mainImage" alt="Selected preview" />
    </div>
    <button class="nav-btn nav-right" id="nextBtn" aria-label="Next image">▶</button>
    <a class="download-btn" id="downloadLink" href="#" download>Download STL</a>
    <button class="toggle-btn" id="toggleViewer" disabled>3D</button>
  </div>
  <aside class="thumbs">
    <h2>&nbsp;</h2>
    <div id="thumbList"></div>
    <div class="status" id="status"></div>
  </aside>
  <div class="tabs">
    <button class="tab-btn active" data-tab="readme">README</button>
    <button class="tab-btn" data-tab="license">LICENSE</button>
  </div>
  <section class="tab-panel" id="readme-tab">
    <!--README-->
  </section>
  <section class="tab-panel hidden" id="license-tab">
    <!--LICENSE-->
  </section>
</div>

<script type="module">
import * as THREE from "three";
import { STLLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/STLLoader.js";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";

const mainImage = document.getElementById("mainImage");
const thumbList = document.getElementById("thumbList");
const statusEl = document.getElementById("status");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const toggleBtn = document.getElementById("toggleViewer");
const downloadLink = document.getElementById("downloadLink");
const viewer = document.getElementById("viewer");
const viewerMedia = document.getElementById("viewerMedia");
const tabButtons = [...document.querySelectorAll(".tab-btn")];
const readmeTab = document.getElementById("readme-tab");
const licenseTab = document.getElementById("license-tab");

let images = [];
let current = 0;
let stlMode = false;

/* Three.js viewer */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf7f7f7);

const camera = new THREE.PerspectiveCamera(
  60,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
camera.position.set(40, 40, 40);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setPixelRatio(window.devicePixelRatio);
viewerMedia.appendChild(renderer.domElement);

new OrbitControls(camera, renderer.domElement);
scene.add(new THREE.AmbientLight(0xffffff, 0.85));
const dirLight = new THREE.DirectionalLight(0xffffff, 0.4);
dirLight.position.set(2, 3, 4);
scene.add(dirLight);

const loader = new STLLoader();
let currentMesh = null;
let currentEdges = null;

function setStatus(message) {
  statusEl.textContent = message || "";
}

function setTab(name) {
  tabButtons.forEach(btn => {
    btn.classList.toggle("active", btn.dataset.tab === name);
  });
  readmeTab.classList.toggle("hidden", name !== "readme");
  licenseTab.classList.toggle("hidden", name !== "license");
}

function setActive(index) {
  current = index;
  const item = images[current];
  mainImage.src = item.src;
  stlMode = false;
  viewer.classList.remove("stl-mode");
  toggleBtn.textContent = "3D";
  toggleBtn.disabled = !item.stl;
  if (item.stl) {
    downloadLink.href = item.stl;
    downloadLink.classList.remove("disabled");
  } else {
    downloadLink.href = "#";
    downloadLink.classList.add("disabled");
  }
  [...thumbList.querySelectorAll("button")].forEach((btn, i) => {
    btn.classList.toggle("active", i === current);
  });
}

function buildThumbs() {
  thumbList.innerHTML = "";
  images.forEach((item, i) => {
    const btn = document.createElement("button");
    const img = document.createElement("img");
    img.src = item.src;
    img.alt = `Thumbnail ${i + 1}`;
    btn.addEventListener("click", () => setActive(i));
    btn.appendChild(img);
    thumbList.appendChild(btn);
  });
}

function next() {
  if (!images.length) return;
  setActive((current + 1) % images.length);
}

function prev() {
  if (!images.length) return;
  setActive((current - 1 + images.length) % images.length);
}

prevBtn.addEventListener("click", prev);
nextBtn.addEventListener("click", next);

window.addEventListener("keydown", (event) => {
  if (event.key === "ArrowRight") next();
  if (event.key === "ArrowLeft") prev();
});

tabButtons.forEach(btn => {
  btn.addEventListener("click", () => setTab(btn.dataset.tab));
});

function loadStl(stlPath) {
  setStatus("Loading STL...");
  loader.load(
    stlPath,
    geometry => {
      geometry.center();
      if (currentMesh) scene.remove(currentMesh);
      if (currentEdges) scene.remove(currentEdges);
      const material = new THREE.MeshStandardMaterial({
        color: 0xffff66,
        metalness: 0.0,
        roughness: 0.9
      });
      currentMesh = new THREE.Mesh(geometry, material);
      scene.add(currentMesh);
      const edges = new THREE.EdgesGeometry(geometry);
      currentEdges = new THREE.LineSegments(
        edges,
        new THREE.LineBasicMaterial({ color: 0x000000 })
      );
      scene.add(currentEdges);
      setStatus("");
    },
    undefined,
    () => setStatus("Failed to load STL")
  );
}

function toggleViewer() {
  const item = images[current];
  if (!item.stl) return;
  stlMode = !stlMode;
  viewer.classList.toggle("stl-mode", stlMode);
  toggleBtn.textContent = stlMode ? "Image" : "3D";
  if (stlMode) loadStl(item.stl);
}

toggleBtn.addEventListener("click", toggleViewer);

function resize() {
  const rect = viewerMedia.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  if (width === 0 || height === 0) return;
  camera.aspect = width / height;
  camera.updateProjectionMatrix();
  renderer.setSize(width, height);
}

window.addEventListener("resize", resize);

function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
animate();

async function init() {
  try {
    const res = await fetch("images.json");
    images = await res.json();
    if (!Array.isArray(images) || images.length === 0) throw new Error("empty");
    buildThumbs();
    setActive(0);
    resize();
    setTab("readme");
  } catch (err) {
    setStatus("No images found.");
  }
}

init();
</script>

</body>
</html>
